// Некая кнопка вызывает внешнее прерывание INT0. Число нажатий на кнопку подсчитывается и отображается
// на светодиодах. Когда число нажатий превысит 7, INT0 запрещается и разрешается прерывание INT1.
// Производится аналогичный подсчет нажатий на кнопку. Когда число нажатий опять превысит 7,
// то все светодиоды начинают мигать с частотой, определяемой прерыванием по сравнению Т\С1 (уставка = $eaff)


.include "m8515def.inc"
;??????? 4 ???
.def stack = r20
.def temp = r16 ;??????? ??????????
.def Count_time = r17 ;??????? ????????
.def Counter = r18 ;??????? ???????
.def Flag = r19 ;??????? ??????: ???? ??? 0 ??????????,
.def Razr2 = r21
.def Razr1 = r22
.def Razr0 = r23
;============ ?????????? ============
rjmp RESET ;Reset Handle
rjmp INT_0 ;External Interrupt0 Vector Address
rjmp INT_1 ;External Interrupt1 Vector Address
reti ;Timer1 capture Interrupt Vector Address
rjmp TIM1COMPA ;Timer1 compare Interrupt Vector Address
reti ;Timer1 Overflow Interrupt Vector Address
reti ;Timer0 Overflow Interrupt Vector Address
reti ;UART Receive Complete Interrupt Vector Address
reti ;UART Data Register Empty Interrupt Vector Address
reti ;UART Transmit Complete Interrupt Vector Address
reti ;Analog Comparator Interrupt Vector Addres


INT_0: ;??????? ?????????? ?? ?????? ?1
inc Counter ;??. ???? ????????, ??????????? ???????
out PORTB,Counter ;??????? ??????? ? ???? B
cpi Counter,7
breq out_INT0
fuflo:
ldi Razr2,$06
ldi Razr1,$1A
ldi Razr0,$80
rcall Delay
in temp,PIND
cpi temp,$FF
brne fuflo
reti

INT_1:
inc Counter ;??. ???? ????????, ??????????? ???????
out PORTB,Counter ;??????? ??????? ? ???? B
cpi Counter,7
breq out_INT1
fuflo_1:
ldi Razr2,$06
ldi Razr1,$1A
ldi Razr0,$80
rcall Delay
in temp,PIND
cpi temp,$FF
brne fuflo_1
reti

Delay: ;????????? ????????
subi Razr0,1
sbci Razr1,0
sbci Razr2,0
;brcc Delay
ret ;??????? ?? ?????????


out_INT0:
ldi temp,(0<<INT0) ;?????? INT_0
out GICR,temp
ldi temp,(1<<INT1) ;?????????? INT_1
out GICR,temp
ldi temp,(1<<ISC11 | 1<<ISC10) ;???? INT_1 ?? ??????
out MCUCR,temp
clr Counter
reti

out_INT1:
ldi Razr2,$06
ldi Razr1,$1A
ldi Razr0,$80
rcall Delay

ldi temp,(0<<INT1) ;?????? ???? INT1
out GICR,temp
ldi temp,$00     ;????? ????? ???
out PortB,temp
ldi temp,(1<<OCIE1A) ;???? ???? ?? ???? Timer1 ? ????????
out TIMSK,temp
ldi temp,$ea         ;?????? ??????? OCR1A
out OCR1AH,temp
ldi temp,$FF
out OCR1AL,temp
ldi temp,0b00000011 ;?????? Timer1 1/64
out TCCR1B,temp
reti

TIM1COMPA:
in temp,PortB       ;????????? ??????? ????????? ??????,????????????? ? ??????
com temp
out PortB,temp
reti




RESET: ;????????? ?????????????
ldi stack,low(RAMEND) ;???????? ????????? ?????
out SPL,stack
ldi stack,high(RAMEND)
out SPH,stack



ldi temp,0xFF 
out DDRB,temp        ;???? ? ??? ???????? ?? ?????
out PORTB,temp       ;?????????? ????????? ???????????      
clr Counter ;??????? ???????
clr Flag ;??????? ??? ????
ldi temp,(1<<ISC01| 1<<ISC00) ;????????????? ????. INT_0 ?? ??????
out MCUCR,temp
ldi temp,(1<<INT0) ;????????? ?????????? INT_0
out GICR,temp

sei ;????????? ?????????? 


end: ;???????? ?????? ????
rjmp end

